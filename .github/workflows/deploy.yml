name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - dev
      - qa
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || github.ref_name }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure AWS credentials for Dev
        if: ${{ github.ref == 'refs/heads/dev' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_DEV }}
          aws-region: us-east-1

      - name: Configure AWS credentials for QA
        if: ${{ github.ref == 'refs/heads/qa' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_QA }}
          aws-region: us-east-1

      - name: Configure AWS credentials for Prod
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: us-east-1

      - name: Set variables
        run: |
          BRANCH=${GITHUB_REF##*/}
          if [[ "$BRANCH" == "main" ]]; then ENV=prod; else ENV=$BRANCH; fi
          STACK_NAME="DataOnboarding-${ENV}"
          S3_BUCKET="dataonboardingapp-eb-artifacts-${ENV}"
          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "STACK_NAME=$STACK_NAME" >> $GITHUB_ENV
          echo "EB_S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV

      - name: Create S3 buckets
        run: |
          # Create EB artifacts bucket first
          aws s3 mb s3://${EB_S3_BUCKET} || true
          # Create CloudFormation artifacts bucket
          aws s3 mb s3://dataonboardingapp-cfn-artifacts-${ENV} || true

      - name: Archive application
        run: zip -r app.zip . -x "**/.git*" "**/.github/*"

      - name: Upload artifact to S3
        run: |
          S3_KEY="app.zip"
          aws s3 cp app.zip s3://${EB_S3_BUCKET}/${S3_KEY}
          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Package CloudFormation
        run: |
          aws cloudformation package \
            --template-file infra/cloudformation.yaml \
            --s3-bucket dataonboardingapp-cfn-artifacts-${ENV} \
            --output-template-file packaged.yaml

      - name: Deploy CloudFormation stack
        run: |
          aws cloudformation deploy \
            --template-file packaged.yaml \
            --stack-name ${STACK_NAME} \
            --parameter-overrides $(jq -r '.Parameters | to_entries | map("\(.key)=\(.value)") | join(" ")' infra/parameters/${ENV}-parameters.json) SourceBundleKey=${S3_KEY} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset